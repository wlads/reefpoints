<!DOCTYPE html><html><head><title>Context Validations</title><link href="/stylesheets/all-8e1315c1.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - An alternative to the normal Rails validations' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2013/05/09/context-validations.html' name='twitter:url'><meta content='Context Validations' name='twitter:title'><meta content='An alternative to the normal Rails validations' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O.. 
                                                             OZ..O.   
                                                         ..OO..87.    
                                                        .O7O..O...    
                                                      .O...Z~O.       
                                                   .:Z~. ..Z..        
                                                  +O.O   .8..         
                                     ...       .OO.  O  O?.           
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..            
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.              
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.                
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.                 
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO                   
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..                 
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.                 
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.                 
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.                 
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:                  
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..                 
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z                   
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O                   
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.                   
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.                   
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.                    
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.                    
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..                    
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.                       
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..                        
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...                          
          .....~OOOOOOOOOOOOOOOOO:........                            
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/work'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/team'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/community'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/contact'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/brian-cardarella.html">Brian Cardarella</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/bcardarella' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/bcardarella' target='_blank'>g</a></span></li><li class='post-meta post-date'>09 May 2013</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby.html">Ruby (28)</a>, <a class="tag-link" href="/categories/ruby-on-rails.html">Ruby on Rails (21)</a>, <a class="tag-link" href="/categories/gems.html">Gems (7)</a></p><div class='post-title-wrap'><h1 class='post-title'>Context Validations</h1></div><current_page class='post-content'><p>I just released a new <a href="https://github.com/dockyard/context_validations">gem called ContextValidations</a></p>

<p>ContextValidations allows you to set validations on the instance of
ActiveRecord models. Any class-level validations you have already set
in your models are ignored. You may be asking yourself &quot;Whaaaaaat?&quot; so
let&#39;s look into why.</p>

<h2>Conditional Validations Are A Smell</h2>

<p>When applications grow in complexity the validation models required to
support them usually grow too. Eventually you will have to &quot;work around&quot;
the validations with conditionals that rely upon state flags. In some
cases you end up writing empty model objects for use with your forms to
avoid the mess that conditional validations introduce.</p>

<p>The problem here is that the model is defining a single set of
validations but the model needs to absorb different sets of data under
different circumstances. Imagine you have a user account that where
depending upon how the users get to your app will depend upon what data
they need to provide. You might also be importing data from an external
incomplete data set. Do you set these records aside into another table
until the records are claimed and the user can complete registration? Or
do you allow the records to save and have the model enter a state of
<code>unclaimed</code> to avoid authentication until <code>claimed</code>? You could just
avoid the validations all together but you definitely don&#39;t want to
allow records that don&#39;t have the most basic of identifying information
such as <code>email</code> or <code>username</code> to be saved.</p>

<p>You can imagine with this scenario the current solution with Rails is
either a very complex and messy validation model or breaking things out
into other models and having a strategy to reconciling that at a later
point in time.</p>

<h2>Context Matters</h2>

<p>I have come to believe that defining a monolithic validation set in your
model is the wrong way to go. Context matters. If I am an admin I should
be able to write data to a record that might not be acceptable to a
regular user. Even the simple case of not requiring a password unless
the record is new.</p>

<h3>Controllers Are the Context</h3>

<p>I believe the rule of &quot;Fat Model, Skinny Controller&quot; has conditioned
Rails developers to never ever put anything more than a few lines of
code into your controllers. For the most part this is a good trend. But
as we have seen with <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> 
there are circumstances where adding a few more lines to our controllers
isn&#39;t going to end the world. I submit the case is also true for
validations. The controller is the context in which the user is
interacting with the data. Going back to the admin example, you most
likely have a <code>UsersController</code> and an <code>Admin::UsersController</code> defined.
Two controllers, same data. Different contexts. Not only should you
allow mass assignment to the models differently for each context but
what is considered &quot;valid data&quot; should also be different.</p>

<h2>Context Validations</h2>

<p>To handle this need I have just released
<a href="https://github.com/dockyard/context_validations">ContextValidations</a>.
The goals of this gem are simple:</p>

<ol>
<li>Maintain simplicity</li>
<li>Enable instance level validations</li>
<li>Don&#39;t deviate from exisitng Rails validations</li>
<li>Backwards compatibility with 3rd party libraries</li>
</ol>

<p>Before I dive into each one let&#39;s see how a set of validations might be
applied in a controller</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">UsersController</span> &lt; <span class="constant">ApplicationController</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Controller</span>

  <span class="keyword">def</span> <span class="function">create</span>
    <span class="instance-variable">@user</span> = <span class="constant">User</span>.new(user_params)
    <span class="instance-variable">@user</span>.validations = validations(<span class="symbol">:create</span>)
    <span class="keyword">if</span> <span class="instance-variable">@user</span>.save
      <span class="comment"># happy path</span>
    <span class="keyword">else</span>
      <span class="comment"># sad path</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">base_validations</span>
    validates <span class="symbol">:first_name</span>, <span class="symbol">:last_name</span> <span class="symbol">:email</span>, <span class="symbol">:presence</span> =&gt; <span class="predefined-constant">true</span>
    validates <span class="symbol">:email</span>, <span class="symbol">:uniqueness</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:format</span> =&gt; <span class="constant">EmailFormat</span>
    validates <span class="symbol">:password</span>, <span class="symbol">:confirmation</span> =&gt; <span class="predefined-constant">true</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">create_validations</span>
    validates <span class="symbol">:password</span>, <span class="symbol">:presence</span> =&gt; <span class="predefined-constant">true</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<h3>Maintain Simplicity</h3>

<p>At this point some of you are probably thinking <a href="http://rhnh.net/2012/12/03/form-objects-in-rails">Form Objects</a>.
Perhaps in the end, Form Objects will be the real answer for what I
strive for. But right now I don&#39;t see a justification for the increase
in complexity. <code>ContextValidations</code> has attempted to keep the complexity
as low as possible while still allowing for flexibility. The
<code>ContextValidations::Controller</code> module can be mixed into any object,
not just controllers. Let&#39;s say you had a <a href="http://stevelorek.com/service-objects.html">Service Object</a></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">UserService</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Controller</span>

  <span class="keyword">def</span> <span class="function">initialize</span>(params)
    <span class="instance-variable">@params</span> = params
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">create</span>
    <span class="instance-variable">@user</span> = <span class="constant">User</span>.new(create_params)
    <span class="instance-variable">@user</span> = validations(<span class="symbol">:create</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>At this point the code looks identitly to the controller example from
above. The validations are accessible anywhere, from any object.</p>

<h3>Instance level validations</h3>

<p>The real key here is that the instance of the model is able to declare
what its validations are rather than the class. To that end you must
mixin the <code>ContextValidations::Model</code> module into any model you want to
use <code>ContextValidations</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">User</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Base</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Model</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>This mixin will do several things to you <code>ActiveRecord</code> model</p>

<ol>
<li><p>A <code>#validations</code> setter and getter is added. The default for
<code>#validations</code> is an empty array. When any arrays are assigned they are
wrapped in an array and falttened out.</p></li>
<li><p>The <code>:validate</code> callbacks are completed removed. This allows the
model to accept validations set on the class by 3rd party libraries but
these validations will never run.</p></li>
<li><p>The <code>#run_validations!</code> protected method is overwritten to run
through the instance level validations instead of running the
<code>:validate</code> callback.</p></li>
</ol>

<h3>Don&#39;t deviate from exisitng Rails validations</h3>

<p>The only difference from writing your validations now is they are
written on the instance. The <code>#validates</code> method functions exactly the
same way. You can still pass conditional validations if you&#39;d like but I
wouldn&#39;t recommend it.</p>

<h3>Backwards compatibility with 3rd party libraries</h3>

<p>As mentioned above we don&#39;t want your Rails app to crash if 3rd party
libraries are declaring regular Rails validations in your models. They
are just ignored.</p>

<h2>Moving forward</h2>

<p>There are a few directions things could move in. I still haven&#39;t come
up with a simple way to test <code>ContextValidations</code>. There will also be
validations that are always used regardless of the context. I don&#39;t
think it makes sense to constantly rewrite these validations. One
possibility would be to consider the class validations the
<code>base_validations</code> that are always run then you can declare context
validations on the instance. This might cause issues with 3rd party
libraries that are using conditional validations. But, we could easily
get around that by ignoring any class level validations that have
conditionals on them.</p>

<p>I am eager to get feedback on this. I am sure this might cause some
friction as it moves outside of the comfort zone for many Rails devs but
now I am happy with the direction.</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2013/05/09/context-validations.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/contact' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorm.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
