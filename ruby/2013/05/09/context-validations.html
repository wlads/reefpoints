<!DOCTYPE html><html><head><title>Context Validations</title><link href="/stylesheets/all-2555a407.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - An alternative to the normal Rails validations' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2013/05/09/context-validations.html' name='twitter:url'><meta content='Context Validations' name='twitter:title'><meta content='An alternative to the normal Rails validations' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2013 ruby_2013_05 ruby_2013_05_09 ruby_2013_05_09_context-validations'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><a class='ad--ruby' href='http://wickedgoodruby.com' target='_blank'><strong class='ad__text'>Don&rsquo;t miss Wicked Good Ruby Conf in Boston this October 11 &ndash; 12, 2014!</strong></a><h1 class='post__title'>Context Validations</h1><a class="post__author" href="/authors/brian-cardarella.html">Brian Cardarella</a><time class='post__date'>May 9<sup>th</sup>, 2013</time><div class='post__content'><p>I just released a new <a href="https://github.com/dockyard/context_validations">gem called ContextValidations</a></p>

<p>ContextValidations allows you to set validations on the instance of
ActiveRecord models. Any class-level validations you have already set
in your models are ignored. You may be asking yourself &quot;Whaaaaaat?&quot; so
let&#39;s look into why.</p>

<h2>Conditional Validations Are A Smell</h2>

<p>When applications grow in complexity the validation models required to
support them usually grow too. Eventually you will have to &quot;work around&quot;
the validations with conditionals that rely upon state flags. In some
cases you end up writing empty model objects for use with your forms to
avoid the mess that conditional validations introduce.</p>

<p>The problem here is that the model is defining a single set of
validations but the model needs to absorb different sets of data under
different circumstances. Imagine you have a user account that where
depending upon how the users get to your app will depend upon what data
they need to provide. You might also be importing data from an external
incomplete data set. Do you set these records aside into another table
until the records are claimed and the user can complete registration? Or
do you allow the records to save and have the model enter a state of
<code>unclaimed</code> to avoid authentication until <code>claimed</code>? You could just
avoid the validations all together but you definitely don&#39;t want to
allow records that don&#39;t have the most basic of identifying information
such as <code>email</code> or <code>username</code> to be saved.</p>

<p>You can imagine with this scenario the current solution with Rails is
either a very complex and messy validation model or breaking things out
into other models and having a strategy to reconciling that at a later
point in time.</p>

<h2>Context Matters</h2>

<p>I have come to believe that defining a monolithic validation set in your
model is the wrong way to go. Context matters. If I am an admin I should
be able to write data to a record that might not be acceptable to a
regular user. Even the simple case of not requiring a password unless
the record is new.</p>

<h3>Controllers Are the Context</h3>

<p>I believe the rule of &quot;Fat Model, Skinny Controller&quot; has conditioned
Rails developers to never ever put anything more than a few lines of
code into your controllers. For the most part this is a good trend. But
as we have seen with <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> 
there are circumstances where adding a few more lines to our controllers
isn&#39;t going to end the world. I submit the case is also true for
validations. The controller is the context in which the user is
interacting with the data. Going back to the admin example, you most
likely have a <code>UsersController</code> and an <code>Admin::UsersController</code> defined.
Two controllers, same data. Different contexts. Not only should you
allow mass assignment to the models differently for each context but
what is considered &quot;valid data&quot; should also be different.</p>

<h2>Context Validations</h2>

<p>To handle this need I have just released
<a href="https://github.com/dockyard/context_validations">ContextValidations</a>.
The goals of this gem are simple:</p>

<ol>
<li>Maintain simplicity</li>
<li>Enable instance level validations</li>
<li>Don&#39;t deviate from exisitng Rails validations</li>
<li>Backwards compatibility with 3rd party libraries</li>
</ol>

<p>Before I dive into each one let&#39;s see how a set of validations might be
applied in a controller</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">UsersController</span> &lt; <span class="constant">ApplicationController</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Controller</span>

  <span class="keyword">def</span> <span class="function">create</span>
    <span class="instance-variable">@user</span> = <span class="constant">User</span>.new(user_params)
    <span class="instance-variable">@user</span>.validations = validations(<span class="symbol">:create</span>)
    <span class="keyword">if</span> <span class="instance-variable">@user</span>.save
      <span class="comment"># happy path</span>
    <span class="keyword">else</span>
      <span class="comment"># sad path</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">base_validations</span>
    validates <span class="symbol">:first_name</span>, <span class="symbol">:last_name</span> <span class="symbol">:email</span>, <span class="symbol">:presence</span> =&gt; <span class="predefined-constant">true</span>
    validates <span class="symbol">:email</span>, <span class="symbol">:uniqueness</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:format</span> =&gt; <span class="constant">EmailFormat</span>
    validates <span class="symbol">:password</span>, <span class="symbol">:confirmation</span> =&gt; <span class="predefined-constant">true</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">create_validations</span>
    validates <span class="symbol">:password</span>, <span class="symbol">:presence</span> =&gt; <span class="predefined-constant">true</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<h3>Maintain Simplicity</h3>

<p>At this point some of you are probably thinking <a href="http://rhnh.net/2012/12/03/form-objects-in-rails">Form Objects</a>.
Perhaps in the end, Form Objects will be the real answer for what I
strive for. But right now I don&#39;t see a justification for the increase
in complexity. <code>ContextValidations</code> has attempted to keep the complexity
as low as possible while still allowing for flexibility. The
<code>ContextValidations::Controller</code> module can be mixed into any object,
not just controllers. Let&#39;s say you had a <a href="http://stevelorek.com/service-objects.html">Service Object</a></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">UserService</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Controller</span>

  <span class="keyword">def</span> <span class="function">initialize</span>(params)
    <span class="instance-variable">@params</span> = params
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">create</span>
    <span class="instance-variable">@user</span> = <span class="constant">User</span>.new(create_params)
    <span class="instance-variable">@user</span> = validations(<span class="symbol">:create</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>At this point the code looks identitly to the controller example from
above. The validations are accessible anywhere, from any object.</p>

<h3>Instance level validations</h3>

<p>The real key here is that the instance of the model is able to declare
what its validations are rather than the class. To that end you must
mixin the <code>ContextValidations::Model</code> module into any model you want to
use <code>ContextValidations</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">User</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Base</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Model</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>This mixin will do several things to you <code>ActiveRecord</code> model</p>

<ol>
<li><p>A <code>#validations</code> setter and getter is added. The default for
<code>#validations</code> is an empty array. When any arrays are assigned they are
wrapped in an array and falttened out.</p></li>
<li><p>The <code>:validate</code> callbacks are completed removed. This allows the
model to accept validations set on the class by 3rd party libraries but
these validations will never run.</p></li>
<li><p>The <code>#run_validations!</code> protected method is overwritten to run
through the instance level validations instead of running the
<code>:validate</code> callback.</p></li>
</ol>

<h3>Don&#39;t deviate from exisitng Rails validations</h3>

<p>The only difference from writing your validations now is they are
written on the instance. The <code>#validates</code> method functions exactly the
same way. You can still pass conditional validations if you&#39;d like but I
wouldn&#39;t recommend it.</p>

<h3>Backwards compatibility with 3rd party libraries</h3>

<p>As mentioned above we don&#39;t want your Rails app to crash if 3rd party
libraries are declaring regular Rails validations in your models. They
are just ignored.</p>

<h2>Moving forward</h2>

<p>There are a few directions things could move in. I still haven&#39;t come
up with a simple way to test <code>ContextValidations</code>. There will also be
validations that are always used regardless of the context. I don&#39;t
think it makes sense to constantly rewrite these validations. One
possibility would be to consider the class validations the
<code>base_validations</code> that are always run then you can declare context
validations on the instance. This might cause issues with 3rd party
libraries that are using conditional validations. But, we could easily
get around that by ignoring any class level validations that have
conditionals on them.</p>

<p>I am eager to get feedback on this. I am sure this might cause some
friction as it moves outside of the comfort zone for many Rails devs but
now I am happy with the direction.</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2013/05/09/context-validations.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/brian-cardarella.jpg'><h5 class='post__avatar__name'>Brian Cardarella</h5><h5 class='post__avatar__position headline--sub'>CEO
</h5></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Brian</h3><a class="related-post" href="/2014/05/31/building-an-ember-app-with-rails-part-4.html"><h2 class='related-post__title'>Building an Ember App with Rails Part 4</h2><p>May 31<sup>st</sup>, 2014</p></a>
<a class="related-post" href="/2014/05/09/building-an-ember-app-with-rails-part-3.html"><h2 class='related-post__title'>Building an Ember App with Rails Part 3</h2><p>May 9<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/brian-cardarella.html">See all 65 posts by Brian</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(45)</span></a> <a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(36)</span></a> <a class="post__tag" href="/categories/gems.html">Gems&nbsp;<span class='post__tag__count'>(10)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgr" target="_blank" href="http://wickedgoodruby.com/">Wicked Good Ruby Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/05/31/building-an-ember-app-with-rails-part-4.html"><strong>Building an Ember App with Rails Part 4</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/05/27/avoid-rails-when-generating-json-responses-with-postgresql.html"><strong>Avoid Rails When Generating JSON responses with PostgreSQL</strong><h6 class='footer-desc'>Let's use PostgreSQL instead of Ruby to generate JSON responses</h6></a>
<a class="footer__post" href="/2014/05/09/building-an-ember-app-with-rails-part-3.html"><strong>Building an Ember App with Rails Part 3</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
