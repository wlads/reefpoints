<!DOCTYPE html><html><head><title>Running PostgreSQL 9.2 on Travis-CI</title><link href="/stylesheets/all-95e8dd0f.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - Test your gem against the latest PostgreSQL version (or an older one)' name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2013/03/29/running-postgresql-9-2-on-travis-ci.html' name='twitter:url'><meta content='Running PostgreSQL 9.2 on Travis-CI' name='twitter:title'><meta content='Test your gem against the latest PostgreSQL version (or an older one)' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2013 ruby_2013_03 ruby_2013_03_29 ruby_2013_03_29_running-postgresql-9-2-on-travis-ci'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><div class='ad'><a href='http://wickedgoodruby.com' target='_blank'>Don't miss Wicked Good Ruby Conf in Boston this October 11 - 12, 2014!</a></div><h1 class='post__title'>Running PostgreSQL 9.2 on Travis-CI</h1><a class="post__author" href="/authors/dan-mcclain.html">Dan McClain</a><time class='post__date'>March 29<sup>th</sup>, 2013</time><div class='post__content'><p>I spent most of yesterday trying to get PostgreSQL 9.2 running <a href="http://travis-ci.org">Travis-CI</a>.
After almost 30 attempts, I successfully tested <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> against PostgreSQL 9.2.</p>

<p>Here is the final <code>before_script</code> needed to install PostgreSQL 9.2.</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
</pre></td>
  <td class="code"><pre>before_script:
  - sudo /etc/init.d/postgresql stop
  - sudo cp /etc/postgresql/9.1/main/pg_hba.conf ./
  - sudo apt-get remove postgresql postgresql-9.1 -qq --purge
  - source /etc/lsb-release
  - echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ $DISTRIB_CODENAME-pgdg main&quot; &gt; pgdg.list
  - sudo mv pgdg.list /etc/apt/sources.list.d/
  - wget --quiet -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | sudo apt-key add -
  - sudo apt-get update
  - sudo apt-get -o Dpkg::Options::=&quot;--force-confdef&quot; -o Dpkg::Options::=&quot;--force-confnew&quot; install postgresql-9.2 postgresql-contrib-9.2 -qq
  - sudo /etc/init.d/postgresql stop
  - sudo cp ./pg_hba.conf /etc/postgresql/9.2/main
  - sudo /etc/init.d/postgresql start
</pre></td>
</tr></table>
</div></div>
<h2>Step by step explanation</h2>

<h3>Out with the old</h3>

<p>Currently, Travis-CI has PostgreSQL 9.1 installed with a passwordless <code>postgres</code> superuser role. We first stop the current user by calling
<code>sudo /etc/init.d/postgresql stop</code>. We also want to copy the current <code>pg_hba.conf</code>, since we can reuse it with PostgreSQL 9.2 to disable the need
for a password for the <code>postgres</code> role. We then remove the currently installed version via <code>sudo apt-get remove postgresql postgresql-9.1 -qq --purge</code>.</p>

<h3>Add the apt.postgresql.org repositories</h3>

<p><a href="http://postgresql.org">Postgresql.org</a> maintains Debian and Ubuntu packages of the current PostgreSQL 8.3, 8.4, 9.0, 9.1 and 9.2 builds at
<a href="http://apt.postgresql.org">apt.postgresql.org</a> (<a href="https://wiki.postgresql.org/wiki/Apt">more
information</a>). Since Travis-CI
workers run Ubuntu, we can leverage these packages. We first load the
Ubuntu distribution environment variables via <code>source /etc/lsb-release</code>.
Using the <code>$DISTRIB_CODENAME</code> variable, we can set up the pgdg.list file
that we will add to the apt-get sources list directory. We do so with
the following command:</p>
<div class="highlight text "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ $DISTRIB_CODENAME-pgdg main&quot; &gt; pgdg.list
sudo mv pgdg.list /etc/apt/sources.list.d/
</pre></td>
</tr></table>
</div></div>
<p>The last thing we have to do before we can start installing the 9.2 is
to import postgresql.org&#39;s apt key via</p>
<div class="highlight text "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>wget --quiet -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | sudo apt-key add -
</pre></td>
</tr></table>
</div></div>
<h3>In with the new</h3>

<p>After we update our package listing via <code>sudo apt-get update</code>, we can
install <code>postgresql-9.2</code> and <code>postgresql-contrib-9.2</code> (needed for the
PostgreSQL extensions) via:</p>
<div class="highlight text "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>sudo apt-get -o Dpkg::Options::=&quot;--force-confdef&quot; -o Dpkg::Options::=&quot;--force-confnew&quot; install postgresql-9.2 postgresql-contrib-9.2 -qq
</pre></td>
</tr></table>
</div></div>
<p>We need the <code>Dpkg::Options</code> to automatically resolve any configuration
file conflicts left behind by 9.1 (even though we purge the files, for
some reason the <code>/etc/init.d/postgresql</code> file gets left behind). Without
the <code>Dpkg::Options</code>, apt-get will raise a user prompt that will hang the
Travis-CI build.</p>

<p>At this point, we have a vanilla install of PostgreSQL 9.2, which will
prompt for a password for the <code>postgres</code> role. We then need to stop the
server, replace the 9.2 <code>pg_hba.conf</code> with the custom Travis-CI one we
copied earlier, then restart the server:</p>
<div class="highlight text "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>sudo /etc/init.d/postgresql stop
sudo cp ./pg_hba.conf /etc/postgresql/9.2/main
sudo /etc/init.d/postgresql start
</pre></td>
</tr></table>
</div></div>
<p>At this point, you can use any other <code>before_script</code> commands you were
previously using to create your database.</p>

<h2>Conclusion</h2>

<p>After a decent amount of trial and error, I arrived at the above
<code>before_script</code> to install PostgreSQL 9.2. I am currently adding support
for <a href="http://www.postgresql.org/docs/9.2/static/rangetypes.html">ranges</a>
to postgres<em>ext, which was added in 9.2. You should be able use this
`before</em>script` to add 9.2 to your Travis-CI builds.</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2013/03/29/running-postgresql-9-2-on-travis-ci.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/dan-mcclain.jpg'><h5 class='post__avatar__name'>Dan McClain</h5><h5 class='post__avatar__position headline--sub'>Partner &amp; Developer<br>At DockYard
</h5></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Dan</h3><a class="related-post" href="/2014/02/07/native-app-developers-we-can-help-you.html"><h2 class='related-post__title'>Native App Developers: We Can Help You</h2><p>February 7<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/02/07/announcing-postgres_ext-postgis.html"><h2 class='related-post__title'>Announcing PostgresExt-PostGIS</h2><p>February 7<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/dan-mcclain.html">See all 16 posts by Dan</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(39)</span></a> <a class="post__tag" href="/categories/postgresql.html">PostgreSQL&nbsp;<span class='post__tag__count'>(11)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgr" target="_blank" href="http://wickedgoodruby.com/">Wicked Good Ruby Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/05/05/preserve-scroll-position-in-ember-apps.html"><strong>Preserve scrolling position in Ember Apps</strong><h6 class='footer-desc'>A simple mixin for your views</h6></a>
<a class="footer__post" href="/2014/05/04/stop-using-ember-appkit-rails.html"><strong>Stop using Ember Appkit Rails</strong><h6 class='footer-desc'>Just stop</h6></a>
<a class="footer__post" href="/2014/05/03/guarding-with-arrays.html"><strong>Guarding with arrays</strong><h6 class='footer-desc'>A common pattern we use</h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
