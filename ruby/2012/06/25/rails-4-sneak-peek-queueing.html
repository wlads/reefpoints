<!DOCTYPE html><html><head><title>Rails 4.0 Sneak Peek: Queueing</title><link href="/stylesheets/all-804a5f51.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - A look at the new Queueing API' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/06/25/rails-4-sneak-peek-queueing.html' name='twitter:url'><meta content='Rails 4.0 Sneak Peek: Queueing' name='twitter:title'><meta content='A look at the new Queueing API' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_06 ruby_2012_06_25 ruby_2012_06_25_rails-4-sneak-peek-queueing'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Rails 4.0 Sneak Peek: Queueing</h1><a class="post__author" href="/authors/brian-cardarella.html">Brian Cardarella</a><time class='post__date'>June 25<sup>th</sup>, 2012</time><div class='post__content'><p>Recently a <a href="https://github.com/rails/rails/commit/adff4a706a5d7ad18ef05303461e1a0d848bd662">queueing system was added to Rails</a>.
Let&#39;s dive in and see how to use it.</p>

<h2>Run, baby, run!</h2>

<p>The queueing API is very simple. You push an object on to the queue and
that object is expected to respond to a <code>run</code> method. Let&#39;s take a look:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">TestJob</span>
  <span class="keyword">def</span> <span class="function">run</span>
    puts <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>For most people, that is pretty much it. The queue is running in a
separate thread from the app thread, so your app shouldn&#39;t notice any
response impact from an expensive job.</p>

<p>The basic queue that comes with Rails is not a long-term solution. The
goal here is to establish a common API that more robust queueing systems
can plug themselves into. In most cases you shouldn&#39;t need to change any
of your app code if you want to switch from
<a href="https://github.com/defunkt/resque">Resque</a> to
<a href="https://github.com/mperham/sidekiq">Sidekiq</a>. You should take care that
the objects you are enqueing can be properly marshalled.</p>

<p>You can even write your own queue, let&#39;s take a look at the API of a
custom queue</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span>
  <span class="keyword">def</span> <span class="function">push</span>(job)
    job.run
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Then in your <code>application.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config.queue = <span class="constant">MyQueue</span>
</pre></td>
</tr></table>
</div></div>
<p>This example is straight from the Rails test suite. This will define a
queue that does not run jobs asynchronously. As soon as the job is
pushed onto the queue it is run. Let&#39;s make an actual queue (without relying on
the Queue class)</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span>
  <span class="keyword">def</span> <span class="function">initialize</span>
    <span class="instance-variable">@queue</span> = []
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">push</span>(job)
    <span class="instance-variable">@queue</span>.push(job)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">pop</span>
    <span class="instance-variable">@queue</span>.pop
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>In this example we have implemented a simple queue. You will next need
to tell Rails&#39;s QueueConsumer to use this queue. You can do this in
<code>application.rb</code> with an initializer block:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>intializer <span class="string"><span class="delimiter">'</span><span class="content">start queue consumer</span><span class="delimiter">'</span></span> <span class="keyword">do</span> |app|
  app.queue_consumer = config.queue_consumer.start(app.queue)
  at_exit { app.queue.consumer.shutdown }
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>and if we now push to our new queue:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
</pre></td>
</tr></table>
</div></div>
<p>...we get nothing. Why? Inspect the QueueConsumer:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.application.queue_consumer
=&gt; <span class="comment">#&lt;Rails::Queueing::ThreadedConsumer @queue=#&lt;MyQueue @queue=[]&gt;, @thread=#&lt;Thread dead&gt;&gt;</span>
</pre></td>
</tr></table>
</div></div>
<p>So you&#39;ll notice that the thread is <code>dead</code>. We can force the queue to
process by doing:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.application.queue_consumer.start
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Let&#39;s back up to understand what is going on here. First we&#39;ll start by looking at <code>ThreadedConsumer#start</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">start</span>
  <span class="instance-variable">@thread</span> = <span class="constant">Thread</span>.new <span class="keyword">do</span>
    <span class="keyword">while</span> job = <span class="instance-variable">@queue</span>.pop
      <span class="keyword">begin</span>
        job.run
      <span class="keyword">rescue</span> <span class="constant">Exception</span> =&gt; e
        handle_exception e
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="predefined-constant">self</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>So this thread is only staying alive as long as the <code>@queue.pop</code> returns a truthy value.
It&#39;s not reasonable or us to keep shoving something into the queue, so let&#39;s see what is happening 
in <code>Queue#pop</code>. For this we&#39;ll look at Rubinius&#39; implementation</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
</pre></td>
  <td class="code"><pre><span class="comment"># Retrieves data from the queue.  If the queue is empty, the calling thread is</span>
<span class="comment"># suspended until data is pushed onto the queue.  If +non_block+ is true, the</span>
<span class="comment"># thread isn't suspended, and an exception is raised.</span>
<span class="comment">#</span>
<span class="keyword">def</span> <span class="function">pop</span>(non_block=<span class="predefined-constant">false</span>)
  <span class="keyword">while</span> <span class="predefined-constant">true</span>
    <span class="instance-variable">@mutex</span>.synchronize <span class="keyword">do</span>
      <span class="instance-variable">@waiting</span>.delete(<span class="constant">Thread</span>.current)
      <span class="keyword">if</span> <span class="instance-variable">@que</span>.empty?
        raise <span class="constant">ThreadError</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">queue empty</span><span class="delimiter">&quot;</span></span> <span class="keyword">if</span> non_block
        <span class="instance-variable">@waiting</span>.push <span class="constant">Thread</span>.current
        <span class="instance-variable">@resource</span>.wait(<span class="instance-variable">@mutex</span>)
      <span class="keyword">else</span>
        retval = <span class="instance-variable">@que</span>.shift
        <span class="instance-variable">@resource</span>.signal
        <span class="keyword">return</span> retval
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>This now starts to make sense. <code>Queue#pop</code> is an infinite loop that will wait until it has
content before each iteration. Our simple <code>MyQueue</code> class would return <code>nil</code> when <code>ThreadConsumer#start</code>
is called because there is nothing in the queue and the thread would die. Even if we put something in
queue it would pop once, run the job, try to pop againg, then die.</p>

<p>For the sake of simplicity let&#39;s just have <code>MyQueue</code> inherit from
<code>Queue</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span> &lt; <span class="constant">Queue</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Now we can run</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>The queue system in Rails 4.0 is a very simple solution, I&#39;m looking
forward to the release and the support for it to be added to many of the
leading background job processing libraries.</p>

<p>Keep in mind that as of this writing the master branch is still
versioned as &#39;beta&#39;. This API could change.</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/06/25/rails-4-sneak-peek-queueing.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/brian-cardarella.jpg'><h5 class='post__avatar__name'>Brian Cardarella</h5><h5 class='post__avatar__position headline--sub'>CEO At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/bcardarella">bcardarella</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/bcardarella">bcardarella</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Brian</h3><a class="related-post" href="/2014/08/06/the-most-difficult-position-to-hire-for-in-tech-right-now.html"><h2 class='related-post__title'>The most difficult position to hire for in tech right now</h2><p>August 6<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/06/23/goodbye-heroku.html"><h2 class='related-post__title'>Goodbye Heroku</h2><p>June 23<sup>rd</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/brian-cardarella.html">See all 67 posts by Brian</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(45)</span></a> <a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(36)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/08/22/design-an-experience.html"><strong>Designing an Experience</strong><h6 class='footer-desc'>A parallel between live performance and experience design.</h6></a>
<a class="footer__post" href="/2014/08/06/the-most-difficult-position-to-hire-for-in-tech-right-now.html"><strong>The most difficult position to hire for in tech right now</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/07/29/project-carpe-diem.html"><strong>Project Carpe Diem - "Game Plan"</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
