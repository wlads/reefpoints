<!DOCTYPE html><html><head><title>Rails 4.0 Sneak Peek: Asynchronous ActionMailer</title><link href="/stylesheets/all-e7e7283c.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - How to send your emails using the new Rails 4.0 Queue' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/06/26/rails-4-sneak-peek-async-actionmailer.html' name='twitter:url'><meta content='Rails 4.0 Sneak Peek: Asynchronous ActionMailer' name='twitter:title'><meta content='How to send your emails using the new Rails 4.0 Queue' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_06 ruby_2012_06_26 ruby_2012_06_26_rails-4-sneak-peek-async-actionmailer'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Rails 4.0 Sneak Peek: Asynchronous ActionMailer</h1><a class="post__author" href="/authors/brian-cardarella.html">Brian Cardarella</a><time class='post__date'>June 26<sup>th</sup>, 2012</time><div class='post__content'><p>My previous <a href="http://reefpoints.dockyard.com/ruby/2012/06/25/rails-4-sneak-peek-queueing.html">deep dive into the Rails 4.0 Queueing system</a>
 was motivated by a patch to Rails I was working on while at <a href="http:/railscamps.org">RailsCamp New England</a> this past weekend. I&#39;m happy to say that <a href="https://github.com/rails/rails/pull/6839">Rails 4.0 now has an optional asynchronous ActionMailer</a>.</p>

<p>The API for pushing your emails to the background is very simple. If you
want to make this change application wide simply set it in your
<code>application.rb</code> (or in any of the environment files)</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config.action_mailer.async = <span class="predefined-constant">true</span>
</pre></td>
</tr></table>
</div></div>
<p>Or if you want to only make specific mailers asynchrounous</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">WelcomeMailer</span> &lt; <span class="constant">ActionMailer</span>::<span class="constant">Base</span>
  <span class="predefined-constant">self</span>.async = <span class="predefined-constant">true</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>That&#39;s it! Any messages that are being delivered will be sent as a
background job. In fact, the rendering is happening on the background as
well.</p>

<p>You will need to take care that the arguments you are passing your
mailers can be properly marshalled. Instead of:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">WelcomeMailer</span>.welcome(<span class="instance-variable">@user</span>).deliver
</pre></td>
</tr></table>
</div></div>
<p>You should do:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">WelcomeMailer</span>.welcome(<span class="instance-variable">@user</span>.id).deliver
</pre></td>
</tr></table>
</div></div>
<p>Then in your mailer:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">WelcomeMailer</span> &lt; <span class="constant">ActionMailer</span>::<span class="constant">Base</span>
  <span class="keyword">def</span> <span class="function">welcome</span>(id)
    <span class="instance-variable">@user</span> = <span class="constant">User</span>.find(id)
    ...
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<h2>Switching it up</h2>

<p>The default queueing system is <code>Rails.queue</code>, but you can override this to use any queueing system you
want by overriding <code>ActionMailer::Base#queue</code>.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">WelcomeMailer</span> &lt; <span class="constant">ActionMailer</span>::<span class="constant">Base</span>
  <span class="keyword">def</span> <span class="function">queue</span>
    <span class="constant">MyQueue</span>.new
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Your custom queue should expect the jobs to respond to <code>#run</code>, same as
<code>Rails.queue</code>.</p>

<h2>Credit</h2>

<p>Much of the original code was cribbed (with permission) from <a href="http://blog.zerosum.org">Nick
Plante</a>&#39;s
<a href="https://github.com/zapnap/resque_mailer">resque_mailer</a> gem.</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/06/26/rails-4-sneak-peek-async-actionmailer.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/brian-cardarella.jpg'><h5 class='post__avatar__name'>Brian Cardarella</h5><h5 class='post__avatar__position headline--sub'>CEO At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/bcardarella">bcardarella</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/bcardarella">bcardarella</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Brian</h3><a class="related-post" href="/2014/12/28/lessons-learned-three-years-running-a-software-consultancy.html"><h2 class='related-post__title'>Lessons Learned - Three years of running a software consultancy</h2><p>December 28<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/12/26/pattern-matching-in-elixir-for-rubyists.html"><h2 class='related-post__title'>Pattern Matching in Elixir for Rubyists</h2><p>December 26<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/brian-cardarella.html">See all 73 posts by Brian</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(47)</span></a> <a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(37)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/12/30/modeling-mental-models.html"><strong>Tips on Mental Models</strong><h6 class='footer-desc'>A few things to keep in mind.</h6></a>
<a class="footer__post" href="/2014/12/28/lessons-learned-three-years-running-a-software-consultancy.html"><strong>Lessons Learned - Three years of running a software consultancy</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/12/26/pattern-matching-in-elixir-for-rubyists.html"><strong>Pattern Matching in Elixir for Rubyists</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
