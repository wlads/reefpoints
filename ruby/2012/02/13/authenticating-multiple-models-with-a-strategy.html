<!DOCTYPE html><html><head><title>Authenticating multiple models with a strategy</title><link href="/stylesheets/all-0fea03ed.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - Using the Strategy Pattern to clean up multiple login paths' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/02/13/authenticating-multiple-models-with-a-strategy.html' name='twitter:url'><meta content='Authenticating multiple models with a strategy' name='twitter:title'><meta content='Using the Strategy Pattern to clean up multiple login paths' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O..
                                                             OZ..O.
                                                         ..OO..87.
                                                        .O7O..O...
                                                      .O...Z~O.
                                                   .:Z~. ..Z..
                                                  +O.O   .8..
                                     ...       .OO.  O  O?.
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...
          .....~OOOOOOOOOOOOOOOOO:........
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/work'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/team'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/community'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/contact'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item current' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/brian-cardarella.html">Brian Cardarella</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/bcardarella' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/bcardarella' target='_blank'>g</a></span></li><li class='post-meta post-date'>13 Feb 2012</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby.html">Ruby (29)</a>, <a class="tag-link" href="/categories/ruby-on-rails.html">Ruby on Rails (21)</a>, <a class="tag-link" href="/categories/software-design-patterns.html">Software Design Patterns (3)</a></p><div class='post-title-wrap'><h1 class='post-title'>Authenticating multiple models with a strategy</h1></div><current_page class='post-content'><p>A current project requires that there be multiple models that can sign
in and each one must use the same sign in form. The original
<code>SessionsController#create</code> action looked like the following:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">create</span>
  <span class="keyword">if</span> user = (<span class="constant">Owner</span>.authenticate(params[<span class="symbol">:user</span>]) || <span class="constant">Employee</span>.authenticate(params[<span class="symbol">:user</span>]))
    session[<span class="symbol">:user_id</span>]    = user.id
    session[<span class="symbol">:user_class</span>] = user.class
    redirect_to dashboard_path
  <span class="keyword">else</span>
    render <span class="symbol">:action</span> =&gt; <span class="symbol">:new</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>We&#39;re using <code>has_secure_password</code> and rolling our own authentication.
Considering that, the above was good enough. But... looking down
the line for this app it is likely we will have to support authentication
for more than just two models on the same form. I also don&#39;t like having
logic in my controllers. So I decided to break this logic out and I
chose the <a href="http://en.wikipedia.org/wiki/Strategy_pattern">Strategy Pattern</a> to help.</p>

<p>I like putting all of my strategies into
<code>app/strategies</code>. This required me to add this directory to the Rails
<code>autoload_paths</code>. Simply open up <code>config/application.rb</code>
(not necessary in Rails 3.1+, thanks Artur Roszczyk)</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config.autoload_paths += <span class="string"><span class="delimiter">%W(</span><span class="inline"><span class="inline-delimiter">#{</span>config.root<span class="inline-delimiter">}</span></span><span class="content">/app/strategies</span><span class="delimiter">)</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Next I wrote up a simple spec, thankfully I already had the logic from
the controller so there wasn&#39;t much work to be done here. This went into
<code>spec/strategies/authentication_strategy_spec.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
</pre></td>
  <td class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">spec_helper</span><span class="delimiter">'</span></span>

describe <span class="constant">AuthenticationStrategy</span> <span class="keyword">do</span>
  context <span class="string"><span class="delimiter">'</span><span class="content">authenticating an owner</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    let(<span class="symbol">:owner</span>) { mock(<span class="string"><span class="delimiter">'</span><span class="content">Owner</span><span class="delimiter">'</span></span>) }
    before <span class="keyword">do</span>
      owner.stubs(<span class="symbol">:authenticate</span>).returns(owner)
      <span class="constant">Owner</span>.stubs(<span class="symbol">:where</span>).returns([owner])
    <span class="keyword">end</span>
    it <span class="string"><span class="delimiter">'</span><span class="content">returns an owner</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">owner@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should eq owner
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  context <span class="string"><span class="delimiter">'</span><span class="content">authenticating an employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    let(<span class="symbol">:employee</span>) { mock(<span class="string"><span class="delimiter">'</span><span class="content">Employee</span><span class="delimiter">'</span></span>) }
    before <span class="keyword">do</span>
      employee.stubs(<span class="symbol">:authenticate</span>).returns(employee)
      <span class="constant">Employee</span>.stubs(<span class="symbol">:where</span>).returns([employee])
    <span class="keyword">end</span>
    it <span class="string"><span class="delimiter">'</span><span class="content">returns an employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">employee@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should eq employee
    <span class="keyword">end</span>

  <span class="keyword">end</span>

  describe <span class="string"><span class="delimiter">'</span><span class="content">failing to authenticate</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    context <span class="string"><span class="delimiter">'</span><span class="content">with no attributes</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      it <span class="string"><span class="delimiter">'</span><span class="content">returns nil</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
        <span class="constant">AuthenticationStrategy</span>.run.should be_nil
      <span class="keyword">end</span>
    <span class="keyword">end</span>
    context <span class="string"><span class="delimiter">'</span><span class="content">with no match for owner or employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      it <span class="string"><span class="delimiter">'</span><span class="content">returns nil</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
        <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should be_nil
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Now it was time to make these specs green! The strategy file goes into
<code>app/strategies/authentication_strategy.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">AuthenticationStrategy</span>
  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">run</span>(attributes = <span class="predefined-constant">nil</span>)
    <span class="keyword">return</span> <span class="predefined-constant">nil</span> <span class="keyword">if</span> (attributes.nil? || attributes[<span class="symbol">:email</span>].blank? || attributes[<span class="symbol">:password</span>].blank?)
    <span class="constant">Owner</span>.authenticate(attributes) || <span class="constant">Employee</span>.authenticate(attributes)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>And finally to clean up the controller</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">create</span>
  <span class="keyword">if</span> user = <span class="constant">AuthenticationStrategy</span>.run(params[<span class="symbol">:user</span>])
    session[<span class="symbol">:user_id</span>]    = user.id
    session[<span class="symbol">:user_class</span>] = user.class
    redirect_to dashboard_path
  <span class="keyword">else</span>
   render <span class="symbol">:action</span> =&gt; <span class="symbol">:new</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>In the end this may appear to be more work than is necessary. Keep in
mind that app requirements will expand to support more models. The wins should be obivious
considering that context. If the requirements grow to 5 or 6 models perhaps at that point it makes sense to
actually break the authentication up into <a href="http://en.wikipedia.org/wiki/Identity_management">Identities</a> with a <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">polymorphic 
association</a> to the different models.
But we&#39;ll cross that road when we get there.</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/02/13/authenticating-multiple-models-with-a-strategy.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/contact' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
