<!DOCTYPE html><html><head><title>Love Your lib Directory</title><link href="/stylesheets/all-c4584ad1.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - Patterns for happy hacking' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/02/14/love-your-lib-directory.html' name='twitter:url'><meta content='Love Your lib Directory' name='twitter:title'><meta content='Patterns for happy hacking' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_02 ruby_2012_02_14 ruby_2012_02_14_love-your-lib-directory'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Love Your lib Directory</h1><a class="post__author" href="/authors/brian-cardarella.html">Brian Cardarella</a><time class='post__date'>February 14<sup>th</sup>, 2012</time><div class='post__content'><p><a href="http://blog.codeclimate.com/blog/2012/02/07/what-code-goes-in-the-lib-directory">Be sure to check out Bryan Helmkamp&#39;s blog post on the same topic</a></p>

<p>The <code>lib/</code> directory is the Red Headed Stepchild of your Rails
application. Let&#39;s discuss some conventions for keeping it clean and
what should and shouldn&#39;t go in there.</p>

<h2>It&#39;s not a dump</h2>

<p><img src="/images/dump.jpg" alt="Dump"></p>

<p>Does this look familiar? It does to me. This is what my <code>lib/</code> directory
looked like before I got fed up with it. That truck, that was me dumping more
code into <code>lib/</code>.</p>

<p>In my experience there is one outstanding reason why code ends up
getting dumped into the lib/ directory: A poor understanding of what a
model is. Rails has this way of reinforcing bad habits. Perhaps because
it is so easy to get going some developers never bother to learn that a
model does not in any way need to be attached to a persitence layer.
(i.e. ActiveRecord)</p>

<p>Let&#39;s all agree to the following:</p>

<ol>
<li>All Business Logic Goes Into A Model</li>
<li>All Models Go Into <code>app/models</code></li>
</ol>

<p>When we say &quot;Business Logic&quot; we are of course talking about &quot;Application
Specific Business Logic&quot;. There is always the case of something you&#39;re
working on that is so generic it can be shared with other applications
you are (or will be) working on. Or, even better, with the community in
general as Open Source. That brings me to the next point.</p>

<h2>Understanding the load path</h2>

<p>If you have written a Rubygem, or at the very least, looked through one,
you know that the <code>lib/</code> directory is special. The short version of the
story is that Rubygems iterates over all of the libraries you have
installed as a gem, and appends any <code>lib/</code> directories onto Ruby&#39;s Load
Path. This is basically how Ruby gem files are exposed, so when you as
do a gem require it will iterate through every path in the load path and
give you the first match.</p>

<p>This is also true with Rails. After all of your gems are loaded and your
application is up Rails will append <code>./lib/</code> to your load path. Any
files you put in there can now be required the exact same way gems are.
This gives us an excellent path to extracting general functionality out
into. You can even play tricks with this, in your <code>application.rb</code> file
put the following at the top:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="global-variable">$:</span>.unshift(<span class="constant">File</span>.expand_path(<span class="string"><span class="delimiter">'</span><span class="content">../../lib</span><span class="delimiter">'</span></span>, <span class="predefined-constant">__FILE__</span>))
</pre></td>
</tr></table>
</div></div>
<p>Now in your lib directory create an &#39;active_record&#39; directory and add a
file called &#39;base.rb&#39;. Inside that file add the following:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>raise <span class="string"><span class="delimiter">&quot;</span><span class="content">ZOMG I BROKE RAILS!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Load up your Rails app and watch it throw an exception. Why? Because
your app&#39;s <code>lib/</code> directory was prepended to the load paths and when the
lookup for <code>active_record/base</code> happened the first match was in your
app&#39;s <code>lib/</code> instead of in the proper gem. This of course is more of an interesting hack than anything really
useful. But it does do a good job of demonstrating how Rubygems&#39; lookup
happens.</p>

<h2>Use initializers for initializing, that is all</h2>

<p>I have seen developers dump code into initializers that has no business
being there. Yes, it loads and it works. That is not the point. We have
conventions for a reason. Any code that you feel needs to go into an
initializer and has nothing to do with actually setting preferences or
something of that manner almost always should go into the <code>lib/</code>
directory. If you <strong>must</strong> monkey patch. Put it into the <code>lib/</code>
directory. If you are creating a new class or module that has no
business being in <code>app/models</code> put it in to the <code>lib/</code> directory.</p>

<h2>Using lib/ to extend core, stlib, or a gem</h2>

<p>Far too often I&#39;ve needed to extend a class that is being defined
outside of my project. There are a few ways to deal with this. You can
use a <a href="http://en.wikipedia.org/wiki/Composite_pattern">Composite</a> to
define a new class that you can then play around with. The downside to
this is that I sometimes want to modify a class that is being inherited
by other classes. This is when I think it is appropriate to <a href="http://en.wikipedia.org/wiki/Monkey_patch">Monkey
Patch</a>.</p>

<p>The pattern I have fallen upon is to define a <code>gem_ext/</code> directory and a
<code>gem_ext.rb</code> file in lib. I then make sure the extensions are loaded up
using an initializer. For lack of a better term I call this
<code>lib_loader.rb</code>. Lets start with the loader.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="comment"># config/initializers/lib_loader.rb</span>

require <span class="string"><span class="delimiter">'</span><span class="content">gem_ext</span><span class="delimiter">'</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Simple enough. Now for this example I&#39;ll use a <a href="http://haml-lang.com/">Haml</a> custom filter I wrote.
This filter allows me to write <a href="http://handlebarsjs.com">Handlebars</a>
templates in my views like so:</p>
<div class="highlight haml "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>-<span class="comment"># app/views/home/show.html.haml</span>

<span class="comment">:handlebars</span><span class="comment">
  // handlebars code goes here</span>
</pre></td>
</tr></table>
</div></div>
<p>Now I can easily add handlebar templates to any haml file. This is how I
did it.</p>

<p>Under <code>lib/gem_ext</code> I defined a <code>haml/</code> directory and a <code>haml.rb</code> file. Then I defined <code>haml/custom_filters.rb</code> and inside that file
I added</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="comment"># lib/gem_ext/haml/custom_filters.rb</span>

<span class="keyword">module</span> <span class="class">Haml::Filters</span>
  <span class="keyword">module</span> <span class="class">Handlebars</span>
    include <span class="constant">Base</span>

    <span class="keyword">def</span> <span class="function">render_with_options</span>(text, options)
      type = <span class="string"><span class="delimiter">&quot;</span><span class="content"> type=</span><span class="inline"><span class="inline-delimiter">#{</span>options[<span class="symbol">:attr_wrapper</span>]<span class="inline-delimiter">}</span></span><span class="content">text/x-handlebars</span><span class="inline"><span class="inline-delimiter">#{</span>options[<span class="symbol">:attr_wrapper</span>]<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>
      <span class="string"><span class="delimiter">&lt;&lt;-END</span></span><span class="string"><span class="content">
&lt;script</span><span class="inline"><span class="inline-delimiter">#{</span>type<span class="inline-delimiter">}</span></span><span class="content">&gt;
//&lt;![CDATA[
  </span><span class="inline"><span class="inline-delimiter">#{</span>text.rstrip.gsub(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">    </span><span class="delimiter">&quot;</span></span>)<span class="inline-delimiter">}</span></span><span class="content">
//]]&gt;
&lt;/script&gt;</span><span class="delimiter">
      END</span></span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Now in <code>haml.rb</code> I added</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="comment"># lib/gem_ext/haml.rb</span>

require <span class="string"><span class="delimiter">'</span><span class="content">gem_ext/haml/custom_filters</span><span class="delimiter">'</span></span>
</pre></td>
</tr></table>
</div></div>
<p>And finally in <code>gem_ext.rb</code> I added</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="comment"># lib/gem_ext.rb</span>

require <span class="string"><span class="delimiter">'</span><span class="content">gem_ext/haml</span><span class="delimiter">'</span></span>
</pre></td>
</tr></table>
</div></div>
<p>This gives me a very clean approach to extending classes without
worrying about muddying up the load path with name collisions or other
surprises. In addition this pattern can
be repeated for <code>Core</code> and <code>Stdlib</code> classes in <code>core_ext</code> and <code>stdlib_ext</code>
respectively.</p>

<h2>Using lib/ as a pattern to extracting Rubygems</h2>

<p>A pattern I have fallen upon when wanting to extract functionality out
of an app into a Rubygem has been to first extract that code into the
<code>lib/</code> directoy. From there I have a nice way to test the code in
isolation. I am also forced to write the code as a class independent
from my app. After I am satisfied with what I have I can think about
extracting that into an external gem.</p>

<p>A great example of this is something that <a href="http://p-rob.me">Patrick Robertson</a> wrote for
<a href="http://bostonrb.org">BostonRB</a></p>

<p>We wanted to show the next upcoming event at the top of the website. All
of our events are stored in a Google Calendar. Unfortunately most of the
Google Calendar gems out there are crap. Patrick decided to roll his
own.</p>

<p>You can see that the <a href="https://github.com/bostonrb/bostonrb/blob/master/lib/boston_rb_calendar.rb">boston<em>rb</em>calendar.rb</a>
is requiring several files just like any Gem would. Because of the
isolation <a href="https://github.com/bostonrb/bostonrb/blob/master/spec/lib/boston_rb_calendar_spec.rb">he was able to test the class very easily</a>.</p>

<p>From here, if Patrick wanted to release this as a gem it wouldn&#39;t take
too much effort. Some renaming of classes would be required but he has
all of the major parts in place.</p>

<h2>Go forth and show some &lt;3&lt;3&lt;3&lt;3</h2>

<p>Keeping your code clean pays itself forward in many way. The team you
are apart of or the team you are handing off to will thank you. Heck,
your future self might thank you. The patterns I&#39;ve described here are
ones that I have found success with. If you have noticed other patterns
concerning the <code>lib/</code> directory please feel free to comment!</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/02/14/love-your-lib-directory.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/brian-cardarella.jpg'><h5 class='post__avatar__name'>Brian Cardarella</h5><h5 class='post__avatar__position headline--sub'>CEO At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/bcardarella">bcardarella</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/bcardarella">bcardarella</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Brian</h3><a class="related-post" href="/2014/11/28/ember-wish-list.html"><h2 class='related-post__title'>Ember Wish List</h2><p>November 28<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/11/18/rubygems-redesign.html"><h2 class='related-post__title'>Rubygems.org Redesign</h2><p>November 18<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/brian-cardarella.html">See all 71 posts by Brian</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(46)</span></a> <a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(36)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/11/28/ember-wish-list.html"><strong>Ember Wish List</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/11/18/we-did-it.html"><strong>UX East Camp 2014</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/11/18/rubygems-redesign.html"><strong>Rubygems.org Redesign</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
