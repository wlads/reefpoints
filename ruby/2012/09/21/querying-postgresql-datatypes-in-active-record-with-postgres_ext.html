<!DOCTYPE html><html><head><title>Querying PostgreSQL datatypes in ActiveRecord with postgres_ext</title><link href="/stylesheets/all-8e1315c1.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - Returning records based on array elements and network subnets' name='description'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/09/21/querying-postgresql-datatypes-in-active-record-with-postgres_ext.html' name='twitter:url'><meta content='Querying PostgreSQL datatypes in ActiveRecord with postgres_ext' name='twitter:title'><meta content='Returning records based on array elements and network subnets' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O.. 
                                                             OZ..O.   
                                                         ..OO..87.    
                                                        .O7O..O...    
                                                      .O...Z~O.       
                                                   .:Z~. ..Z..        
                                                  +O.O   .8..         
                                     ...       .OO.  O  O?.           
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..            
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.              
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.                
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.                 
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO                   
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..                 
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.                 
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.                 
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.                 
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.                 
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.                 
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:                  
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..                 
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z                   
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O                   
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.                   
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.                   
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.                    
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.                    
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..                    
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.                       
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..                        
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...                          
          .....~OOOOOOOOOOOOOOOOO:........                            
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/work'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/team'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/community'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/contact'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/dan-mcclain.html">Dan McClain</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/_danmcclain' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/danmcclain' target='_blank'>g</a></span></li><li class='post-meta post-date'>21 Sep 2012</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby.html">Ruby (28)</a>, <a class="tag-link" href="/categories/ruby-on-rails.html">Ruby on Rails (21)</a>, <a class="tag-link" href="/categories/postgresql.html">PostgreSQL (7)</a>, <a class="tag-link" href="/categories/gems.html">Gems (7)</a></p><div class='post-title-wrap'><h1 class='post-title'>Querying PostgreSQL datatypes in ActiveRecord with postgres_ext</h1></div><current_page class='post-content'><p>I created the <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> gem to add ActiveRecord support for 
PostgreSQL datatypes in Rails 3.2+. So far, I have added support for
the CIDR, INET, MACADDR, UUID, and array datatypes. <a href="https://github.com/dockyard/postgres_ext/issues">Please open an issue on GitHub if you&#39;d like other datatypes supported that aren&#39;t currently</a>.
Since we can now add these columns via Rails migrations, and have
INET/CIDR and array columns converted to Ruby <code>IPAddr</code> and <code>Array</code>
objects, resepectively.</p>

<p>Rails 4.0 has also added support for CIDR, INET, MACADDR and array
datatypes.</p>

<p>It would be great if we could take advantage of
PostgreSQL&#39;s query support for these datatypes. Wait, we can already do
that!</p>

<h2>Querying against arrays using <code>ANY</code> and <code>ALL</code></h2>

<p>In PostgreSQL, you can query for records where any or all elements match
a given predicate.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> *
<span class="keyword">FROM</span> users
<span class="keyword">WHERE</span> <span class="string"><span class="delimiter">'</span><span class="content">johnny</span><span class="delimiter">'</span></span> = <span class="keyword">ANY</span>(nicknames)
<span class="comment">-- Finds any record that has 'johnny' stored in the nicknames array</span>

<span class="class">SELECT</span> *
<span class="keyword">FROM</span> user_scores
<span class="keyword">WHERE</span> <span class="integer">1000</span> &gt; <span class="keyword">ALL</span>(scores)
<span class="comment">-- Finds any record that has over 1000 stored in every element in the</span>
<span class="comment">-- scores array</span>
</pre></td>
</tr></table>
</div></div>
<p>We can actually use arel to generate these queries.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

any_nicknames_function = <span class="constant">Arel</span>::<span class="constant">Nodes</span>::<span class="constant">NamedFunction</span>.new(<span class="string"><span class="delimiter">'</span><span class="content">ANY</span><span class="delimiter">'</span></span>, [user_arel[<span class="symbol">:nicknames</span>]])
predicate = <span class="constant">Arel</span>::<span class="constant">Nodes</span>::Equality(<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>, any_nicknames_function)

sql_statement = user_arel.project(<span class="string"><span class="delimiter">'</span><span class="content">*</span><span class="delimiter">'</span></span>).where(predicate).to_sql
<span class="comment">#=&gt; SELECT * FROM \&quot;users\&quot; WHERE 'test' = ANY(\&quot;users\&quot;.\&quot;nicknames\&quot;)</span>

users_with_nickname = <span class="constant">User</span>.find_by_sql(sql_statement)
</pre></td>
</tr></table>
</div></div>
<p>In the above example, we have to create an <code>Equality</code> node manually
since the left hand side of the predicate is the value, instead of the
column. If you need <code>&lt;</code> in your predicate, you would create a <code>LessThan</code>
node instead of an equality node.</p>

<p>This example applies to both Rails 3.2+ with postgres_ext and Rails 4.0
with native array support.</p>

<h2>Array overlap</h2>

<p>In PostgreSQL, you can check if two arrays have one or more elements in
common by using the overlap operator, <code>&amp;&amp;</code>.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="string"><span class="delimiter">'</span><span class="content">{1,2,3}</span><span class="delimiter">'</span></span> &amp;&amp; <span class="string"><span class="delimiter">'</span><span class="content">{4,5,6}</span><span class="delimiter">'</span></span>
<span class="comment">-- f</span>
<span class="string"><span class="delimiter">'</span><span class="content">{1,2,3}</span><span class="delimiter">'</span></span> &amp;&amp; <span class="string"><span class="delimiter">'</span><span class="content">{3,4}</span><span class="delimiter">'</span></span>
<span class="comment">-- t</span>
</pre></td>
</tr></table>
</div></div>
<p>In postgres_ext, I added a new Arel predicate node for the 
overlap operator.  For the time being, it is named <code>ArrayOverlap</code>
and can be called from a <code>Arel::Attribute</code> as <code>#array_overlap</code>. It
is likely that this will be renamed to <code>Overlap</code> and <code>#overlap</code>,
respectively, in the next release of postgres_ext.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

<span class="constant">User</span>.where(user_arel[<span class="symbol">:tags</span>].array_overlap([<span class="string"><span class="delimiter">'</span><span class="content">one</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">two</span><span class="delimiter">'</span></span>])).to_sql
<span class="comment"># =&gt; SELECT \&quot;users\&quot;.* FROM \&quot;users\&quot; WHERE \&quot;users\&quot;.\&quot;tags\&quot; &amp;&amp; '{one,two}'</span>
</pre></td>
</tr></table>
</div></div>
<p>One case that we have used an array column in tandem with the overlap
operator was adding tags to a user. We had three tags that could be
placed on a user, so we stored this data an array column. We then had a
search form which had a multiselect field for that tags column. The
multiselect would give us an array of possible values that we wanted to
find records that had any of those selected values. So instead of
crafting a statement with multiple <code>ANY</code> queries <code>OR</code>ed together, we
used overlap instead, resulting in only one predicate.</p>

<h2>INET/CIDR subnet inclusion</h2>

<p>In PostgreSQL, you can see if a particular INET address is contained in
a specific subnet with the contained within operator, <code>&lt;&lt;</code>.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.6</span><span class="delimiter">'</span></span> &lt;&lt; inet <span class="string"><span class="delimiter">'</span><span class="content">10.0.0.0/24</span><span class="delimiter">'</span></span>
<span class="comment">-- f</span>

inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.6</span><span class="delimiter">'</span></span> &lt;&lt; inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.0/24</span><span class="delimiter">'</span></span>
<span class="comment">-- t</span>
</pre></td>
</tr></table>
</div></div>
<p>In postgres_ext, I added a new Arel predicate node for the 
contained within operator. It can be called from a
<code>Arel::Attribute</code> with <code>#contained_within</code>. I also added a visitor for
IPAddr objects so that they are correctly converted to quoted strings
when called within a Arel predicate.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

<span class="constant">User</span>.where(user_arel[<span class="symbol">:ip_address</span>].contained_within(<span class="string"><span class="delimiter">'</span><span class="content">10.0.0.0/8</span><span class="delimiter">'</span></span>).to_sql
<span class="comment">#=&gt; SELECT \&quot;users\&quot;.* FROM \&quot;users\&quot; WHERE \&quot;users\&quot;.\&quot;ip_address\&quot; &lt;&lt; '10.0.0.0/8'</span>
</pre></td>
</tr></table>
</div></div>
<h2>We&#39;re not done yet</h2>

<p>We have only scratched the surface of the datatype specific functions
and operators in PostgreSQL. There are many more to be implemented, and
the plan is to support them all. This post highlights what has been
implemented so far, and also what you can do with Arel already. I plan
to put together some pull requests for Arel to add in some of the
PostgreSQL operators. If there is an operator missing in postgres_ext
that you want/need, please <a href="https://github.com/dockyard/postgres_ext/issues?state=open">open an issue on
Github</a>!</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/09/21/querying-postgresql-datatypes-in-active-record-with-postgres_ext.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/contact' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorm.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
