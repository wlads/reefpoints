<!DOCTYPE html><html><head><title>Querying PostgreSQL datatypes in ActiveRecord with postgres_ext</title><link href="/stylesheets/all-b8b987fc.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-c78bd1ed.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - Returning records based on array elements and network subnets' name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/09/21/querying-postgresql-datatypes-in-active-record-with-postgres_ext.html' name='twitter:url'><meta content='Querying PostgreSQL datatypes in ActiveRecord with postgres_ext' name='twitter:title'><meta content='Returning records based on array elements and network subnets' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO~        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_09 ruby_2012_09_21 ruby_2012_09_21_querying-postgresql-datatypes-in-active-record-with-postgres_ext'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap reefpoints-wrap'><a class='logo--reefpoints' href='/'>ReefPoints</a><div class='search-wrap'><form class='search' data-url='/'><input class='search__input' id='search' name='search' placeholder='Search all posts' type='text' value=''><button class='search__submit' href='/'></button></form></div><nav class='blog-topnav'><a class="blog-topnav__item " href="/">Posts</a><a class="blog-topnav__item " href="/tags.html">Tags</a><a class="blog-topnav__item " href="/authors.html">Authors</a></nav><div class='post-wrap--no-comments'><aside class='post__metas--post l-post__metas'><a class='icon' data-icon='#' href='http://twitter.com/_danmcclain' target='_blank'><span class='is-hidden'>Twitter</span></a><a class='icon' data-icon='★' href='https://github.com/danmcclain' target='_blank'><span class='is-hidden'>GitHub</span></a><a class="post__meta--author" href="/authors/dan-mcclain.html">Dan McClain</a><p class='post__meta--date'>21 Sep 2012</p><p class='post__meta--tags'><a class="post__meta--tag" href="/tags/ruby.html">Ruby (37)</a> <a class="post__meta--tag" href="/tags/ruby-on-rails.html">Ruby on Rails (27)</a> <a class="post__meta--tag" href="/tags/postgresql.html">PostgreSQL (11)</a> <a class="post__meta--tag" href="/tags/gems.html">Gems (10)</a></p></aside><div class='post l-post'><h1 class='post__title'>Querying PostgreSQL datatypes in ActiveRecord with postgres_ext</h1><current_page class='post__content'><p>I created the <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> gem to add ActiveRecord support for 
PostgreSQL datatypes in Rails 3.2+. So far, I have added support for
the CIDR, INET, MACADDR, UUID, and array datatypes. <a href="https://github.com/dockyard/postgres_ext/issues">Please open an issue on GitHub if you&#39;d like other datatypes supported that aren&#39;t currently</a>.
Since we can now add these columns via Rails migrations, and have
INET/CIDR and array columns converted to Ruby <code>IPAddr</code> and <code>Array</code>
objects, resepectively.</p>

<p>Rails 4.0 has also added support for CIDR, INET, MACADDR and array
datatypes.</p>

<p>It would be great if we could take advantage of
PostgreSQL&#39;s query support for these datatypes. Wait, we can already do
that!</p>

<h2>Querying against arrays using <code>ANY</code> and <code>ALL</code></h2>

<p>In PostgreSQL, you can query for records where any or all elements match
a given predicate.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> *
<span class="keyword">FROM</span> users
<span class="keyword">WHERE</span> <span class="string"><span class="delimiter">'</span><span class="content">johnny</span><span class="delimiter">'</span></span> = <span class="keyword">ANY</span>(nicknames)
<span class="comment">-- Finds any record that has 'johnny' stored in the nicknames array</span>

<span class="class">SELECT</span> *
<span class="keyword">FROM</span> user_scores
<span class="keyword">WHERE</span> <span class="integer">1000</span> &gt; <span class="keyword">ALL</span>(scores)
<span class="comment">-- Finds any record that has over 1000 stored in every element in the</span>
<span class="comment">-- scores array</span>
</pre></td>
</tr></table>
</div></div>
<p>We can actually use arel to generate these queries.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

any_nicknames_function = <span class="constant">Arel</span>::<span class="constant">Nodes</span>::<span class="constant">NamedFunction</span>.new(<span class="string"><span class="delimiter">'</span><span class="content">ANY</span><span class="delimiter">'</span></span>, [user_arel[<span class="symbol">:nicknames</span>]])
predicate = <span class="constant">Arel</span>::<span class="constant">Nodes</span>::Equality(<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>, any_nicknames_function)

sql_statement = user_arel.project(<span class="string"><span class="delimiter">'</span><span class="content">*</span><span class="delimiter">'</span></span>).where(predicate).to_sql
<span class="comment">#=&gt; SELECT * FROM \&quot;users\&quot; WHERE 'test' = ANY(\&quot;users\&quot;.\&quot;nicknames\&quot;)</span>

users_with_nickname = <span class="constant">User</span>.find_by_sql(sql_statement)
</pre></td>
</tr></table>
</div></div>
<p>In the above example, we have to create an <code>Equality</code> node manually
since the left hand side of the predicate is the value, instead of the
column. If you need <code>&lt;</code> in your predicate, you would create a <code>LessThan</code>
node instead of an equality node.</p>

<p>This example applies to both Rails 3.2+ with postgres_ext and Rails 4.0
with native array support.</p>

<h2>Array overlap</h2>

<p>In PostgreSQL, you can check if two arrays have one or more elements in
common by using the overlap operator, <code>&amp;&amp;</code>.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="string"><span class="delimiter">'</span><span class="content">{1,2,3}</span><span class="delimiter">'</span></span> &amp;&amp; <span class="string"><span class="delimiter">'</span><span class="content">{4,5,6}</span><span class="delimiter">'</span></span>
<span class="comment">-- f</span>
<span class="string"><span class="delimiter">'</span><span class="content">{1,2,3}</span><span class="delimiter">'</span></span> &amp;&amp; <span class="string"><span class="delimiter">'</span><span class="content">{3,4}</span><span class="delimiter">'</span></span>
<span class="comment">-- t</span>
</pre></td>
</tr></table>
</div></div>
<p>In postgres_ext, I added a new Arel predicate node for the 
overlap operator.  For the time being, it is named <code>ArrayOverlap</code>
and can be called from a <code>Arel::Attribute</code> as <code>#array_overlap</code>. It
is likely that this will be renamed to <code>Overlap</code> and <code>#overlap</code>,
respectively, in the next release of postgres_ext.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

<span class="constant">User</span>.where(user_arel[<span class="symbol">:tags</span>].array_overlap([<span class="string"><span class="delimiter">'</span><span class="content">one</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">two</span><span class="delimiter">'</span></span>])).to_sql
<span class="comment"># =&gt; SELECT \&quot;users\&quot;.* FROM \&quot;users\&quot; WHERE \&quot;users\&quot;.\&quot;tags\&quot; &amp;&amp; '{one,two}'</span>
</pre></td>
</tr></table>
</div></div>
<p>One case that we have used an array column in tandem with the overlap
operator was adding tags to a user. We had three tags that could be
placed on a user, so we stored this data an array column. We then had a
search form which had a multiselect field for that tags column. The
multiselect would give us an array of possible values that we wanted to
find records that had any of those selected values. So instead of
crafting a statement with multiple <code>ANY</code> queries <code>OR</code>ed together, we
used overlap instead, resulting in only one predicate.</p>

<h2>INET/CIDR subnet inclusion</h2>

<p>In PostgreSQL, you can see if a particular INET address is contained in
a specific subnet with the contained within operator, <code>&lt;&lt;</code>.</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.6</span><span class="delimiter">'</span></span> &lt;&lt; inet <span class="string"><span class="delimiter">'</span><span class="content">10.0.0.0/24</span><span class="delimiter">'</span></span>
<span class="comment">-- f</span>

inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.6</span><span class="delimiter">'</span></span> &lt;&lt; inet <span class="string"><span class="delimiter">'</span><span class="content">192.168.1.0/24</span><span class="delimiter">'</span></span>
<span class="comment">-- t</span>
</pre></td>
</tr></table>
</div></div>
<p>In postgres_ext, I added a new Arel predicate node for the 
contained within operator. It can be called from a
<code>Arel::Attribute</code> with <code>#contained_within</code>. I also added a visitor for
IPAddr objects so that they are correctly converted to quoted strings
when called within a Arel predicate.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>user_arel = <span class="constant">User</span>.arel_table

<span class="constant">User</span>.where(user_arel[<span class="symbol">:ip_address</span>].contained_within(<span class="string"><span class="delimiter">'</span><span class="content">10.0.0.0/8</span><span class="delimiter">'</span></span>).to_sql
<span class="comment">#=&gt; SELECT \&quot;users\&quot;.* FROM \&quot;users\&quot; WHERE \&quot;users\&quot;.\&quot;ip_address\&quot; &lt;&lt; '10.0.0.0/8'</span>
</pre></td>
</tr></table>
</div></div>
<h2>We&#39;re not done yet</h2>

<p>We have only scratched the surface of the datatype specific functions
and operators in PostgreSQL. There are many more to be implemented, and
the plan is to support them all. This post highlights what has been
implemented so far, and also what you can do with Arel already. I plan
to put together some pull requests for Arel to add in some of the
PostgreSQL operators. If there is an operator missing in postgres_ext
that you want/need, please <a href="https://github.com/dockyard/postgres_ext/issues?state=open">open an issue on
Github</a>!</p>
<div class='post__share'><div class='post__share__links'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/09/21/querying-postgresql-datatypes-in-active-record-with-postgres_ext.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div><p>This article is brought to you by <a class='text-link' href='http://dockyard.com/'>DockYard</a>. If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</p><a class='button--post' href='http://dockyard.com/hire-us'>Hire Us</a></div></current_page></div></div><div class='post__comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript></div><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
  
  $('.search').submit(function(event) {
    event.preventDefault();
    window.location = $(this).data('url') + '#q=' + $('.search__input').val();
  });
</script>
<h2 class='nothin'>Your search returned no results. Perhaps you should try again.</h2></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgr" target="_blank" href="http://wickedgoodruby.com/">Wicked Good Ruby Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/03/03/using-database-templates.html"><strong>Using Database Templates in Rails</strong><h6 class='footer-desc'>Discover a helpful Postgres config option</h6></a>
<a class="footer__post" href="/2014/03/03/a-simple-ember-data-route.html"><strong>A Simple Ember Data Route</strong><h6 class='footer-desc'>A basic pattern for routes with Ember Data content</h6></a>
<a class="footer__post" href="/2014/02/07/native-app-developers-we-can-help-you.html"><strong>Native App Developers: We Can Help You</strong><h6 class='footer-desc'>Have an existing application? We can help you out!</h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
