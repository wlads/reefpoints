<!DOCTYPE html><html><head><title>Rails 4.0 Sneak Peek: PostgreSQL array support</title><link href="/stylesheets/all-804a5f51.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - Storing arrays natively in PostgreSQL is now supported by Rails' name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/09/18/rails-4-sneak-peek-postgresql-array-support.html' name='twitter:url'><meta content='Rails 4.0 Sneak Peek: PostgreSQL array support' name='twitter:title'><meta content='Storing arrays natively in PostgreSQL is now supported by Rails' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_09 ruby_2012_09_18 ruby_2012_09_18_rails-4-sneak-peek-postgresql-array-support'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Rails 4.0 Sneak Peek: PostgreSQL array support</h1><a class="post__author" href="/authors/dan-mcclain.html">Dan McClain</a><time class='post__date'>September 18<sup>th</sup>, 2012</time><div class='post__content'><p>I&#39;m happy to announce that <a href="https://github.com/rails/rails/pull/7547">Rails 4.0 now has support for PostgreSQL
arrays</a>. You can create an
array column easily at the time of migration by adding <code>:array =&gt; true</code>.
Creating an array column will respect the other options you add to the
column (<code>length</code>, <code>default</code>, etc). </p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>create_table <span class="symbol">:table_with_arrays</span> <span class="keyword">do</span> |t|
  t.integer <span class="symbol">:int_array</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>
  <span class="comment"># integer[]</span>
  t.integer <span class="symbol">:int_array</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:length</span> =&gt; <span class="integer">2</span>
  <span class="comment"># smallint[]</span>
  t.string <span class="symbol">:string_array</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:length</span> =&gt; <span class="integer">30</span>
  <span class="comment"># char varying(30)[]</span>
<span class="keyword">end</span> 
</pre></td>
</tr></table>
</div></div>
<p>It should be noted when setting the default value for an array column,
you should use PostgreSQL&#39;s array notation for that value
(<code>{value,another value}</code>). If you want the default value to be an empty
array you would have <code>:default =&gt; &#39;{}&#39;</code>.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>create_table <span class="symbol">:table_with_arrays</span> <span class="keyword">do</span> |t|
  t.integer <span class="symbol">:int_array</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:default</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>
  <span class="comment"># integer[], default == []</span>
  t.integer <span class="symbol">:int_array</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>, <span class="symbol">:length</span> =&gt; <span class="integer">2</span>, <span class="symbol">:default</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">{1}</span><span class="delimiter">'</span></span>
  <span class="comment"># smallint[], default == [1]</span>
<span class="keyword">end</span> 
</pre></td>
</tr></table>
</div></div>
<h2>An example of a model with an array value</h2>

<p>Let&#39;s say that we have a user model, which has a formal first and last
name, and also a number of nicknames (I rarely ever go by Daniel). The
following code would create the table we need to store this.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>create_table <span class="symbol">:users</span> <span class="keyword">do</span> |t|
  t.string <span class="symbol">:first_name</span>
  t.string <span class="symbol">:last_name</span>
  t.string <span class="symbol">:nicknames</span>, <span class="symbol">:array</span> =&gt; <span class="predefined-constant">true</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>And we have a simple model for this table:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">User</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Base</span>
  attr_accessible <span class="symbol">:first_name</span>, <span class="symbol">:last_name</span>, <span class="symbol">:nicknames</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Where we don&#39;t have a default value, if we instantiate a User object
with the following</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>john = <span class="constant">User</span>.create(<span class="symbol">:first_name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">John</span><span class="delimiter">'</span></span>, <span class="symbol">:last_name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">Doe</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>If we call <code>john.nicknames</code>, <code>nil</code> would be returned, and is stored as
<code>NULL</code> in PostgresSQL. We can set the nicknames attribute at the time of
creation with</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>john = <span class="constant">User</span>.create(<span class="symbol">:first_name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">John</span><span class="delimiter">'</span></span>, <span class="symbol">:last_name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">Doe</span><span class="delimiter">'</span></span>,
  <span class="symbol">:nicknames</span> =&gt; [<span class="string"><span class="delimiter">'</span><span class="content">Jack</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Johnny</span><span class="delimiter">'</span></span>])
</pre></td>
</tr></table>
</div></div>
<p>If we then retrieved this record from the database, the <code>nicknames</code>
value would be casted to an array, instead of returning the string of
<code>{Jack,Johnny}</code>.  Rails 4.0 has a pure ruby array value parser, but if
you would like to speed up the parsing process, the previously mentioned
<a href="https://github.com/dockyard/pg_array_parser">pg_array_parser</a>
gem will be used if it is available. PgArrayParser has
a C extension, and a Java implementation for JRuby (although the gem
currently broken in JRuby, this is something I am fixing now).</p>

<p>One important thing to note when interacting with array (or other
mutable values) on a model.  ActiveRecord does not currently track
&quot;destructive&quot;, or in place changes. These include array <code>push</code>ing and
<code>pop</code>ing, <code>advance</code>-ing DateTime objects. If you want to use a
&quot;destructive&quot; update, you must call <code>&lt;attribute&gt;_will_change!</code> to let
ActiveRecord know you changed that value. With our User model, if we
wanted to append a nickname, you can do the following:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre>john = <span class="constant">User</span>.first

john.nicknames += [<span class="string"><span class="delimiter">'</span><span class="content">Jackie boy</span><span class="delimiter">'</span></span>]
<span class="comment"># or</span>
john.nicknames = john.nicknames.push(<span class="string"><span class="delimiter">'</span><span class="content">Jackie boy</span><span class="delimiter">'</span></span>)
<span class="comment"># Any time an attribute is set via `=`, ActiveRecord tracks the change</span>
john.save

john.reload
john.nicknames
<span class="comment">#=&gt; ['Jack', 'Johnny', 'Jackie Boy']</span>

john.nicknames.pop
john.nicknames_will_change!
<span class="comment"># '#pop' changes the value in place, so we have to tell ActiveRecord it changed</span>
john.save
</pre></td>
</tr></table>
</div></div>
<p>One last note about arrays in PostgreSQL: there are no element count
constraints, and any array can be multidimensional. With the
multidimensional arrays, they must be &quot;square&quot; (the sub arrays must all
have the same number of elements).</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>[[<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>], [<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>], [<span class="integer">4</span>,<span class="integer">5</span>,<span class="predefined-constant">nil</span>]]
<span class="comment"># Valid array value in PostgreSQL, each subarray has the same number of</span>
<span class="comment"># elements</span>
[<span class="integer">1</span>,<span class="integer">2</span>,[<span class="integer">3</span>,<span class="integer">4</span>]]
<span class="comment"># Invalid array, we are mixing values and arrays at a single level</span>
</pre></td>
</tr></table>
</div></div>
<p>In my next article, I will talk about querying PostgreSQL arrays in both
postgres_ext and Rails 4.0. Go forth and use arrays in Rails 4.0!</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/09/18/rails-4-sneak-peek-postgresql-array-support.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/dan-mcclain.jpg'><h5 class='post__avatar__name'>Dan McClain</h5><h5 class='post__avatar__position headline--sub'>Partner &amp; Developer At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/_danmcclain">_danmcclain</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/danmcclain">danmcclain</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Dan</h3><a class="related-post" href="/2014/05/27/avoid-rails-when-generating-json-responses-with-postgresql.html"><h2 class='related-post__title'>Avoid Rails When Generating JSON responses with PostgreSQL</h2><p>May 27<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/02/07/native-app-developers-we-can-help-you.html"><h2 class='related-post__title'>Native App Developers: We Can Help You</h2><p>February 7<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/dan-mcclain.html">See all 17 posts by Dan</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby.html">Ruby&nbsp;<span class='post__tag__count'>(45)</span></a> <a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(36)</span></a> <a class="post__tag" href="/categories/postgresql.html">PostgreSQL&nbsp;<span class='post__tag__count'>(12)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/08/25/design-and-big-data.html"><strong>Comics and Big Data</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/08/22/design-an-experience.html"><strong>Designing an Experience</strong><h6 class='footer-desc'>A parallel between live performance and experience design.</h6></a>
<a class="footer__post" href="/2014/08/06/the-most-difficult-position-to-hire-for-in-tech-right-now.html"><strong>The most difficult position to hire for in tech right now</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
