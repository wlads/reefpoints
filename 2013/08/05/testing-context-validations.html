<!DOCTYPE html><html><head><title>Testing Context Validations</title><link href="/stylesheets/all-c028aca5.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content="DockYard.com - We moved your model validations to your controller, now we're going to help you test them" name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/2013/08/05/testing-context-validations.html' name='twitter:url'><meta content='Testing Context Validations' name='twitter:title'><meta content="We moved your model validations to your controller, now we're going to help you test them" name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='x2013 x2013_08 x2013_08_05 x2013_08_05_testing-context-validations'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><a class='ad--ruby' href='http://wickedgoodruby.com' target='_blank'><strong class='ad__text'>Don&rsquo;t miss Wicked Good Ruby Conf in Boston this October 11 &ndash; 12, 2014!</strong></a><h1 class='post__title'>Testing Context Validations</h1><a class="post__author" href="/authors/dan-mcclain.html">Dan McClain</a><time class='post__date'>August 5<sup>th</sup>, 2013</time><div class='post__content'><h2>Quick Refresher on ContextValidation</h2>

<p>A few months ago, Brian released the <a href="http://reefpoints.dockyard.com/ruby/2013/05/09/context-validations.html">ContextValidations gem</a>.
ContextValidations moves your model validations to the controller,
allowing you to vary your validations by context, rather than relying on
conditional validations.</p>

<h2>Let&#39;s validate our user</h2>

<p>We have a user model, that requires a password and a username when a
user signs up. They can change their username and password, but if they
can leave the password blank when updating their account, it will retain
the old password. Whenever they enter a password , it must be 9
characters or greater. We&#39;re going to ignore the actual implementation
of the password saving scheme and password confirmation in this example.
Also, this example ignores setting up the test helper for <a href="https://github.com/bcardarella/valid_attribute">valid_attribute</a>
and MiniTest::Spec.</p>

<h3>Implementing the Tests and Validations in the Model</h3>

<p>To test the above requirements model validations, we&#39;d do the following:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre>describe <span class="constant">OldUser</span> <span class="keyword">do</span>
  describe <span class="string"><span class="delimiter">'</span><span class="content">new user</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    subject { <span class="constant">OldUser</span>.new <span class="key">password</span>: <span class="string"><span class="delimiter">'</span><span class="content">password_to_confirm</span><span class="delimiter">'</span></span> }

    it { must have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">bob</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>) }
    it { must have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">validpassword1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>, <span class="string"><span class="delimiter">'</span><span class="content">tooshort</span><span class="delimiter">'</span></span>) }
  <span class="keyword">end</span>

  describe <span class="string"><span class="delimiter">'</span><span class="content">existing user</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    subject { old_users(<span class="symbol">:example</span>) }

    it { must have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">bob</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>) }
    it { must have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>, <span class="string"><span class="delimiter">'</span><span class="content">validpassword1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">tooshort</span><span class="delimiter">'</span></span>) }
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>And here is the implementation of the model:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">OldUser</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Base</span>
  attr_accessor <span class="symbol">:password</span>
  validates <span class="symbol">:username</span>, <span class="key">presence</span>: <span class="predefined-constant">true</span>
  validates <span class="symbol">:password</span>, <span class="key">presence</span>: <span class="predefined-constant">true</span>, <span class="key">if</span>: <span class="symbol">:new_record?</span>
  validates <span class="symbol">:password</span>, <span class="key">length</span>: { <span class="key">minimum</span>: <span class="integer">9</span> }, <span class="key">allow_blank</span>: <span class="predefined-constant">true</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<h3>Implementing the Tests and Validations in the Controller with ContextValidations</h3>

<p>We&#39;ve been using ContextValidations with our client work since its
release and realized we could unit test the controller to test the
validations.</p>

<p>Our unit tests for the controller are here:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre>describe <span class="constant">UsersController</span> <span class="keyword">do</span>
  describe <span class="string"><span class="delimiter">'</span><span class="content">#create</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    subject { <span class="constant">User</span>.new(<span class="key">validations</span>: validations_for(<span class="symbol">:create</span>)) }

    it { must have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">bob</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>) }
    it { must have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">validpassword1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>, <span class="string"><span class="delimiter">'</span><span class="content">tooshort</span><span class="delimiter">'</span></span>) }
  <span class="keyword">end</span>

  describe <span class="string"><span class="delimiter">'</span><span class="content">#update</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    subject { <span class="constant">User</span>.new(<span class="key">validations</span>: validations_for(<span class="symbol">:update</span>)) }

    it { must have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">bob</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:username</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>) }
    it { must have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="predefined-constant">nil</span>, <span class="string"><span class="delimiter">'</span><span class="content">validpassword1234</span><span class="delimiter">'</span></span>) }
    it { wont have_valid(<span class="symbol">:password</span>).when(<span class="string"><span class="delimiter">'</span><span class="content">tooshort</span><span class="delimiter">'</span></span>) }
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Note the use of <code>validations_for</code>. It is a MiniTest
helper method defined by ContextValidations, which looks up the name
of the controller from the describe block, creates an instance of it,
and retrieves the validations for the context passed in. This prevents
you from needing to create your own instance and calling <code>validations</code>
on it. The resulting tests end up looking very similar to what your
model tests would look like.</p>

<p>Our model implementation is very light:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">User</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Base</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Model</span>

  attr_accessor <span class="symbol">:password</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>And our validations are defined in the controller:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">UsersController</span> &lt; <span class="constant">ApplicationController</span>
  include <span class="constant">ContextValidations</span>::<span class="constant">Controller</span>

  private

  <span class="keyword">def</span> <span class="function">base_validations</span>
    validates <span class="symbol">:username</span>, <span class="key">presence</span>: <span class="predefined-constant">true</span>
    validates <span class="symbol">:password</span>, <span class="key">length</span>: { <span class="key">minimum</span>: <span class="integer">9</span> }, <span class="key">allow_blank</span>: <span class="predefined-constant">true</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">create_validations</span>
    validates <span class="symbol">:password</span>, <span class="key">presence</span>: <span class="predefined-constant">true</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>All of the examples are part of <a href="https://github.com/dockyard/testing_context_validations">this repository</a>.</p>

<h2>Wrapping it up</h2>

<p>As you can see, writing the validation tests for the controller are
almost identical to writing them for the model. There are a few
differences in setting up the subject for the tests, but the only major
difference is that you are testing the controller instead of the model.
If you have any feedback on the tests we came up with, feel free to let
us know!</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/2013/08/05/testing-context-validations.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/dan-mcclain.jpg'><h5 class='post__avatar__name'>Dan McClain</h5><h5 class='post__avatar__position headline--sub'>Partner &amp; Developer At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/_danmcclain">_danmcclain</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/danmcclain">danmcclain</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Dan</h3><a class="related-post" href="/2014/05/27/avoid-rails-when-generating-json-responses-with-postgresql.html"><h2 class='related-post__title'>Avoid Rails When Generating JSON responses with PostgreSQL</h2><p>May 27<sup>th</sup>, 2014</p></a>
<a class="related-post" href="/2014/02/07/native-app-developers-we-can-help-you.html"><h2 class='related-post__title'>Native App Developers: We Can Help You</h2><p>February 7<sup>th</sup>, 2014</p></a>
<a class="related-posts-link text-link" href="/authors/dan-mcclain.html">See all 17 posts by Dan</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(36)</span></a> <a class="post__tag" href="/categories/gems.html">Gems&nbsp;<span class='post__tag__count'>(10)</span></a> <a class="post__tag" href="/categories/context-validation.html">Context Validation&nbsp;<span class='post__tag__count'>(1)</span></a> <a class="post__tag" href="/categories/testing.html">Testing&nbsp;<span class='post__tag__count'>(7)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgr" target="_blank" href="http://wickedgoodruby.com/">Wicked Good Ruby Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2014/07/18/design-as-conversation.html"><strong>Design as conversation</strong><h6 class='footer-desc'>Invisible systems of the design process.</h6></a>
<a class="footer__post" href="/2014/06/27/ember-macros-for-DRY-and-testable-code.html"><strong>Ember Macros for DRY and Testable Code</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2014/06/24/introducing_ember_cli_addons.html"><strong>Introducing Ember CLI Addons</strong><h6 class='footer-desc'></h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
