<!DOCTYPE html><html><head><title>Postgres_ext adds rank and common table expressions</title><link href="/stylesheets/all-060121b3.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - In postgres_ext 2.1, complex queries get much easier' name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' name='twitter:url'><meta content='Postgres_ext adds rank and common table expressions' name='twitter:title'><meta content='In postgres_ext 2.1, complex queries get much easier' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='x2013 x2013_09 x2013_09_06 x2013_09_06_postgres_ext-adds-rank-and-common-table-expressions'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Postgres_ext adds rank and common table expressions</h1><a class="post__author" href="/authors/dan-mcclain.html">Dan McClain</a><time class='post__date'>September 6<sup>th</sup>, 2013</time><div class='post__content'><p>This week, I released <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> 2.1.0, which includes
ActiveRecord::Relation methods to simplify queries that require the use
of <a href="http://www.postgresql.org/docs/current/static/queries-with.html">Common Table
Expressions</a>
(CTEs) and the <a href="http://www.postgresql.org/docs/9.2/static/functions-window.html"><code>rank()</code> windowing
function</a>.</p>

<h2>Common Table Expressions</h2>

<p>In a sentence, CTEs allow you to define a temporary table to be used in
a larger query. Let&#39;s look at an example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
</pre></td>
</tr></table>
</div></div>
<p>In the above, somewhat arbitrary, example, we create a temporary table
of <code>scores_for_game</code> which we then select from. CTEs allow you to
organize your more complex queries, and can be really helpful in certain
cases.</p>

<p>We can make the same SQL call in ActiveRecord with postgres_ext.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>, <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>))
</pre></td>
</tr></table>
</div></div>
<p>We can also query against the CTE expression by chaining off the
resulting ActiveRecord::Relation</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>,
  <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>)).where(<span class="key">user_id</span>: <span class="integer">1</span>)
</pre></td>
</tr></table>
</div></div>
<p>would generate the following:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
<span class="keyword">WHERE</span> scores_for_game.user_id = <span class="integer">1</span>
</pre></td>
</tr></table>
</div></div>
<p>You can also include CTEs in your normal queries to join against by
using <code>with</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.with(<span class="key">my_games</span>: <span class="constant">Game</span>.where(<span class="key">id</span>: <span class="integer">1</span>)).joins(<span class="string"><span class="delimiter">'</span><span class="content">JOIN my_games ON scores.game_id = my_games.id</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following SQL:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>WITH my_games <span class="keyword">AS</span> (
<span class="class">SELECT</span> games.*
<span class="keyword">FROM</span> games
<span class="keyword">WHERE</span> games.id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">JOIN</span> my_games
<span class="keyword">ON</span> scores.games_id = my_games.id
</pre></td>
</tr></table>
</div></div>
<h2>Rank</h2>

<p>PostgreSQL provides a <code>rank</code> windowing function, which will take into
account ties when ranking results. You would add rank to your
projection, like the following example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
</pre></td>
</tr></table>
</div></div>
<p>The results set will return ordered by the rank, which is determined the
order passed into the <code>rank</code>&#39;s <code>OVER</code>. In the above example, the scores
would be ranked by their scores descending, so highest score first. If
there was a tie at first place between two scores, they would both
ranked 1, and the next result would be ranked <code>3</code>. We can achieve the
same in ActiveRecord with postgres_ext:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>)
<span class="comment"># or</span>
<span class="constant">Score</span>.ranked(<span class="string"><span class="delimiter">'</span><span class="content">points desc</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>Rank will rank independently of any sort order applied to the query, so
you could have your scores ranked by points, but then ordered by their
creation time.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>).order(<span class="symbol">:created_at</span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following query:</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.created_at <span class="directive">ASC</span>
</pre></td>
</tr></table>
</div></div>
<p>Also, if you apply a sort order to your relation, and want to sort by
it, you do not have to tell ranked what order you&#39;d like to use, as it
will reuse the order. </p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked.order(<span class="key">points</span>: <span class="symbol">:desc</span>)
</pre></td>
</tr></table>
</div></div>
<p>One thing to watch out for if you use <code>ranked</code> without an explicit
order and want to call <a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-first"><code>first</code></a>
off your relation, if the results of the
relation have yet to be retrieved, the first will use your table&#39;s
primary key for an <code>ORDER BY</code> statement on the query. This has already
bitten us before we discovered the behavior of <code>first</code>. To avoid this
behavior in <code>first</code>, use
<a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-take"><code>take</code></a>
which does not use any implied order.</p>

<p>We&#39;ve been using CTEs and rank on one of our client projects, and it&#39;s
already cleaned up the <code>from_sql</code> queries we were previously
using. Let us know if you hit any snags, or have any suggestions on how
else we can make complex SQL queries easier to call from ActiveRecord!
We only implement the <code>rank</code> windowing function right now, but plan to
add the others shortly.</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap'><img class='post__avatar' src='/images/team/dan-mcclain.jpg'><h5 class='post__avatar__name'>Dan McClain</h5><h5 class='post__avatar__position headline--sub'>Partner &amp; Developer At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/_danmcclain">_danmcclain</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/danmcclain">danmcclain</a></nav></div><div class='related-posts'><h3 class='related-posts__header headline--sub'>Other posts by Dan</h3><a class="related-post" href="/2015/01/28/bubbling-actions-through-components.html"><h2 class='related-post__title'>Bubbling actions through components</h2><p>January 28<sup>th</sup>, 2015</p></a>
<a class="related-post" href="/2015/01/07/complex-search-pages-feel-better-in-ember.html"><h2 class='related-post__title'>Complex Search Pages Feel Better in Ember</h2><p>January 7<sup>th</sup>, 2015</p></a>
<a class="related-posts-link text-link" href="/authors/dan-mcclain.html">See all 19 posts by Dan</a></div></div><p class='post__tags'><a class="post__tag" href="/categories/ruby-on-rails.html">Ruby on Rails&nbsp;<span class='post__tag__count'>(37)</span></a> <a class="post__tag" href="/categories/gems.html">Gems&nbsp;<span class='post__tag__count'>(10)</span></a> <a class="post__tag" href="/categories/postgres_ext.html">Postgres_ext&nbsp;<span class='post__tag__count'>(4)</span></a> <a class="post__tag" href="/categories/postgresql.html">PostgreSQL&nbsp;<span class='post__tag__count'>(12)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2015/01/30/why-i-am-disappointed-in-react-native.html"><strong>Why I'm disappointed in React Native</strong><h6 class='footer-desc'></h6></a>
<a class="footer__post" href="/2015/01/30/empowering-through-design.html"><strong>Empowering through Design</strong><h6 class='footer-desc'>The UX benefits of Single Page Web Apps</h6></a>
<a class="footer__post" href="/2015/01/28/estimation-buyers-guide.html"><strong>Estimation Buyers Guide</strong><h6 class='footer-desc'>Buyer beware of estimates without understanding how it was derived</h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>101 Tremont Street<br>Suite 200<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="http://reefpoints.dockyard.com/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
